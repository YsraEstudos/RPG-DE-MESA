<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha RPG Zumbi - Avan√ßada (Auto-Save + Compress√£o)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Roboto&display=swap" rel="stylesheet">
    <style>
        /* --- Global Styles & Variables --- */
        :root {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --primary-accent: #dc3545; /* Red */ --secondary-accent: #28a745; /* Green */ --input-bg: #333; --border-color: var(--secondary-accent); --button-bg: #444; --button-hover-bg: #555; --font-family-main: 'VT323', monospace; --font-family-readable: 'Roboto', sans-serif;
            /* Body Map Colors */
            --panel-bg: #2b2b2b; --svg-border-color: #444; --accent-color: #b02a37; --accent-hover: #dc3545; --selection-glow-color: dodgerblue;
            /* Health Colors */
            --health-color-healthy: #5cb85c; --health-color-damaged: #f0ad4e; --health-color-critical: #d9534f; --health-color-destroyed: #6c757d;
            /* Status Colors */
            --status-bleed-color: red; --status-infect-color: purple; --status-fire-color: orangered;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-family-main); font-size: 18px; line-height: 1.6; padding: 20px; }
        /* --- Main Layout & Containers --- */
        .main-container { max-width: 1300px; margin: 0 auto; padding: 15px; border: 2px solid var(--primary-accent); background-color: #222; box-shadow: 0 0 15px rgba(220, 53, 69, 0.5); }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { color: var(--primary-accent); font-size: 3em; margin-bottom: 5px; text-shadow: 2px 2px 0px #000; }
        header h2 { color: var(--text-color); font-size: 1.5em; margin-bottom: 15px; }
        /* Save indicator */
        #save-status { color: #888; font-size: 0.8em; position: fixed; bottom: 10px; right: 10px; background-color: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 3px; opacity: 0; transition: opacity 0.3s ease; }
        #save-status.visible { opacity: 1; }
        /* --- Section Layouts --- */
         .health-map-wrapper { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; align-items: flex-start; }
         .health-section { flex: 1 1 300px; border: 1px solid var(--border-color); padding: 15px; background-color: var(--bg-color); border-radius: 4px; }
         .body-map-container { flex: 2 1 500px; display: flex; gap: 20px; border: 1px solid var(--svg-border-color); padding: 15px; background-color: var(--panel-bg); border-radius: 4px; align-items: flex-start; }
        .section { border: 1px solid var(--border-color); padding: 15px; margin-bottom: 20px; background-color: var(--bg-color); border-radius: 4px; }
         .section-title { color: var(--primary-accent); font-size: 1.4em; margin-bottom: 15px; border-bottom: 1px dashed var(--primary-accent); padding-bottom: 5px; font-family: var(--font-family-main); }
        .grid-container-bottom { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        /* --- General Form Elements & Buttons --- */
        button { font-family: var(--font-family-main); background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--primary-accent); padding: 8px 15px; font-size: 1em; cursor: pointer; transition: background-color 0.2s ease; margin: 5px 0; border-radius: 3px; }
        button:hover { background-color: var(--button-hover-bg); }
        button.action-button { background-color: var(--primary-accent); border-color: #fff; }
        button.action-button:hover { background-color: #b02a37; }
        button.heal-button { background-color: var(--secondary-accent); border-color: #fff; }
        button.heal-button:hover { background-color: #218838; }
        input[type="number"], input[type="text"] { font-family: var(--font-family-main); background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px; font-size: 1em; width: 80px; text-align: center; border-radius: 3px; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        label { margin-right: 10px; }
        /* --- Derived Health Display --- */
        .derived-health-display { font-size: 1.8em; font-weight: bold; color: var(--secondary-accent); margin: 0 10px; }
        .derived-health-status { font-size: 1.2em; font-style: italic; color: var(--secondary-accent); display: block; margin-top: 10px; }
        /* --- Damage Log --- */
        #damage-log { height: 150px; background-color: var(--input-bg); border: 1px solid var(--border-color); padding: 10px; overflow-y: scroll; font-size: 0.9em; margin-top: 10px; border-radius: 3px; white-space: pre-wrap; font-family: var(--font-family-readable); }
        #damage-log p { margin-bottom: 5px; border-bottom: 1px dashed #555; padding-bottom: 3px; }
        #damage-log p:last-child { border-bottom: none; }
        /* --- Resistances --- */
        .resistance-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 5px; border-bottom: 1px dashed #444; }
        .resistance-item:last-child { border-bottom: none; }
        .resistance-item label { flex-basis: 50%; }
        .resistance-item input { width: 60px; }
        /* --- Inventory --- */
        #inventory-list li { display: flex; align-items: center; gap: 10px; padding: 8px 5px; border-bottom: 1px dashed #444; cursor: pointer; transition: background-color 0.2s ease; font-family: var (--font-family-readable); }
        #inventory-list li:last-child { border-bottom: none; }
        #inventory-list li:hover { background-color: #333; }
        .item-icon { font-size: 1.3em; min-width: 25px; text-align: center; }
        .item-name { font-weight: bold; }
        .item-qty { color: #aaa; font-size: 0.9em; }
        ul { list-style: none; padding-left: 0; }
        li { margin-bottom: 5px; }
        /* === Body Map Specific Styles === */
        .body-visual-container { flex-shrink: 0; }
        #human-svg { width: 180px; height: 360px; border: 1px solid var(--svg-border-color); background-color: #222; }
        .body-part-svg path { fill: var(--health-color, var(--health-color-healthy)); stroke: var(--svg-border-color); stroke-width: 1; cursor: pointer; transition: fill 0.4s ease, filter 0.3s ease; }
        .body-part-svg:hover path { filter: brightness(1.2); }
        .body-part-svg.selected path { filter: url(#selection-glow); }
        .body-part-svg.hit path { animation: hit-animation 0.3s ease-out; }
        @keyframes hit-animation { 0% { fill: red; transform: scale(1.02); } 50% { fill: red; transform: scale(0.98); } 100% { fill: var(--health-color, var(--health-color-healthy)); transform: scale(1); } }
        .body-part-svg.bleeding path { filter: url(#bleeding-effect); }
        .body-part-svg.bleeding.selected path { filter: url(#bleeding-effect) url(#selection-glow); }
        .body-part-svg.infected path { fill: url(#infection-pattern), var(--health-color, var(--health-color-healthy)); }
        .body-part-svg.infected.selected path { filter: url(#selection-glow); }
        .body-part-svg.burning path { animation: fire-animation 1s infinite alternate; filter: url(#fire-glow); }
        .body-part-svg.burning.selected path { filter: url(#fire-glow) url(#selection-glow); }
        @keyframes fire-animation { 0% { fill: orange; } 50% { fill: orangered; } 100% { fill: darkred; } }
        /* Info Panel for Body Map */
        .info-panel { flex-grow: 1; min-width: 250px; color: var(--text-color); font-family: var(--font-family-readable); }
        .info-panel h2, .info-panel h3 { font-family: var(--font-family-main); color: var(--text-color); border-bottom: 1px solid var(--svg-border-color); padding-bottom: 5px; margin-bottom: 10px; }
        .info-panel hr { border-top: 1px solid var(--svg-border-color); margin: 10px 0; }
        .info-panel p { margin-bottom: 8px; }
        #actions button { display: block; width: calc(100% - 10px); margin: 8px 5px; padding: 8px 12px; cursor: pointer; background-color: var(--accent-color); color: white; border: none; border-radius: 4px; text-align: center; transition: background-color 0.2s ease; font-family: var(--font-family-main); font-size: 0.95em; }
        #actions button:hover { background-color: var(--accent-hover); }
        .hidden { display: none; }
        /* Utility class for visually hidden elements */
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    </style>
    <!-- Pako CDN for compression -->
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
    <div class="main-container">
        <header>
            <h1>FICHA RPG ZUMBI</h1>
            <div id="save-status">Salvo automaticamente</div>
            <!-- Optional: Status indicator
            <p><small id="save-status" style="color: #888;">Carregando...</small></p> -->
        </header>

        <div class="health-map-wrapper">
            <div class="health-section">
                <h3 class="section-title">Condi√ß√£o Geral</h3>
                <p> <label>Sa√∫de Geral Calculada:</label> <span id="derived-current-health" class="derived-health-display">100</span>% </p>
                <p> <label>Status Geral Calculado:</label> <span id="derived-health-status" class="derived-health-status">Saud√°vel</span> </p>
                <hr style="border-color: var(--border-color); margin: 15px 0;">
                <p style="font-family: var(--font-family-readable); font-size: 0.9em; color: #ccc;"> A sa√∫de geral √© derivada da condi√ß√£o das partes do corpo. As altera√ß√µes s√£o salvas automaticamente (comprimido). </p> {/* Updated text */}
                <div style="margin-top: 20px;">
                    <label for="general-damage-input">Aplicar Dano Distribu√≠do:</label>
                    <input type="number" id="general-damage-input" value="10" min="0">
                    <button onclick="applyDamageGeneral()" class="action-button">Distribuir Dano</button>
                </div>
                 <div style="margin-top: 10px;">
                    <button onclick="attemptGeneralHealingItem()" class="heal-button">Usar Item de Cura (Selecionado)</button>
                    <p style="font-family: var(--font-family-readable); font-size: 0.8em; color: #aaa;">Tenta usar item de cura na parte do corpo selecionada.</p>
                </div>
            </div>

            <div class="body-map-container">
                <div class="body-visual-container">
                     <svg viewBox="0 0 150 300" id="human-svg" xmlns="http://www.w3.org/2000/svg">
                         <defs>
                             <pattern id="infection-pattern" patternUnits="userSpaceOnUse" width="6" height="6"> <path d="M0 0 H6 V6 H0 Z" fill="rgba(128, 0, 128, 0.1)" /> <path d="M-1,1 l2,-2 M0,6 l6,-6 M5,7 l2,-2" style="stroke:rgba(128, 0, 128, 0.4); stroke-width:0.5;" /> </pattern>
                             <filter id="bleeding-effect" x="-50%" y="-50%" width="200%" height="200%"> <feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="var(--status-bleed-color)" flood-opacity="0.8" /> <feDropShadow dx="0" dy="0" stdDeviation="4" flood-color="var(--status-bleed-color)" flood-opacity="0.5" /> </filter>
                             <filter id="selection-glow" x="-50%" y="-50%" width="200%" height="200%"> <feDropShadow dx="0" dy="0" stdDeviation="3" flood-color="var(--selection-glow-color)" flood-opacity="1" /> </filter>
                              <filter id="fire-glow" x="-50%" y="-50%" width="200%" height="200%"> <feGaussianBlur stdDeviation="2" result="blur"/> <feFlood flood-color="orange" flood-opacity="0.7" result="color"/> <feComposite in="color" in2="blur" operator="in" result="glow"/> <feMerge> <feMergeNode in="glow"/> <feMergeNode in="SourceGraphic"/> </feMerge> </filter>
                         </defs>
                         <g class="body-part-svg" id="part-l-leg" data-part-name="Perna Esquerda"> <path d="M50,175 Q45,240 40,300 H60 Q65,240 70,175 Z"/> </g>
                         <g class="body-part-svg" id="part-r-leg" data-part-name="Perna Direita"> <path d="M80,175 Q85,240 90,300 H110 Q105,240 100,175 Z"/> </g>
                         <g class="body-part-svg" id="part-l-arm" data-part-name="Bra√ßo Esquerdo"> <path d="M35,65 Q25,100 20,160 L35,165 Q40,100 48,70 Z" /> </g>
                         <g class="body-part-svg" id="part-r-arm" data-part-name="Bra√ßo Direito"> <path d="M102,70 Q110,100 115,165 L130,160 Q125,100 115,65 Z"/> </g>
                         <g class="body-part-svg" id="part-torso" data-part-name="Tronco"> <path d="M40,55 C40,40 110,40 110,55 Q115,120 110,175 H40 Q35,120 40,55 Z"/> </g>
                         <g class="body-part-svg" id="part-head" data-part-name="Cabe√ßa"> <path d="M55,50 Q75,0 95,50 Q90,60 75,60 Q60,60 55,50 Z" /> </g>
                     </svg>
                </div>

                <div class="info-panel" id="info-panel">
                    <h2>Detalhes da Parte do Corpo</h2>
                    <p><strong>Selecionada:</strong> <span id="info-part-name">-</span></p>
                    <p><strong>Vida:</strong> <span id="info-part-health">--</span> / <span id="info-part-max-health">--</span></p>
                    <p><strong>Status:</strong> <span id="info-part-status">-</span></p>
                    <hr>
                    <div id="actions" class="hidden">
                        <h3>A√ß√µes na Parte</h3>
                        <button id="btn-damage-light">Dano Leve Local (-10)</button> <button id="btn-damage-heavy">Dano Pesado Local (-30)</button> <button id="btn-bleed">Aplicar Sangramento</button> <button id="btn-infect">Aplicar Infec√ß√£o</button> <button id="btn-burn">Aplicar Queimadura</button> <button id="btn-cure-status">Remover Status Negativo</button>
                    </div>
                    <p id="no-selection-msg">Clique em uma parte do corpo no diagrama.</p>
                </div>
            </div>
        </div>

        <div class="grid-container-bottom">
            <div class="section">
                <h3 class="section-title">Resist√™ncias</h3>
                <div class="resistance-item"> <label for="res-fisico">F√≠sico:</label> <div><input type="number" class="resistance-input" id="res-fisico" value="0" min="0"> %</div> </div>
                <div class="resistance-item"> <label for="res-fogo">Fogo:</label> <div><input type="number" class="resistance-input" id="res-fogo" value="0" min="0"> %</div> </div>
                <div class="resistance-item"> <label for="res-frio">Frio:</label> <div><input type="number" class="resistance-input" id="res-frio" value="0" min="0"> %</div> </div>
                <div class="resistance-item"> <label for="res-veneno">Veneno:</label> <div><input type="number" class="resistance-input" id="res-veneno" value="0" min="0"> %</div> </div>
                <div class="resistance-item"> <label for="res-eletrico">El√©trico:</label> <div><input type="number" class="resistance-input" id="res-eletrico" value="0" min="0"> %</div> </div>
                <div class="resistance-item"> <label for="res-radiacao">Radia√ß√£o:</label> <div><input type="number" class="resistance-input" id="res-radiacao" value="0" min="0"> %</div> </div>
                 <p style="font-family: var(--font-family-readable); font-size: 0.8em; color: #aaa; margin-top: 10px;">Resist√™ncias reduzem dano. Salvo automaticamente.</p>
            </div>

            <div class="section">
                 <h3 class="section-title">Invent√°rio</h3>
                 <ul id="inventory-list"> <li>Nenhum item.</li> </ul>
                 <button onclick="addInventoryItem()">Adicionar Item</button>
            </div>

             <div class="section">
                 <h3 class="section-title">Registro de Eventos</h3>
                  <div id="damage-log"> <p data-timestamp="0"></p> </div>
             </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- === DATA STRUCTURES & CONSTANTS === ---
            const DATA_VERSION = "1.3-pako-compressed"; // Updated version to indicate compression format
            // Ensure the key is different from previous versions due to format change
            const localStorageKey = 'zombieRPGCharSheet_AutoSave_v' + DATA_VERSION.split('-')[0] + '_compressed';
            const AUTO_SAVE_DELAY = 2500;
            const PERIODIC_SAVE_INTERVAL = 60000; // Auto-save every minute as backup

            let bodyPartsData = {}; let inventoryData = [];
            let selectedPartId = null; let autoSaveTimeoutId = null;
            let periodicSaveIntervalId = null;
            let lastSaveTime = Date.now();
            const hitAnimationTimeout = 300;
            const validDamageTypes = ['fisico', 'fogo', 'frio', 'veneno', 'eletrico', 'radiacao'];

            const defaultBodyPartsData = { /* same as before */
                'part-head': { name: 'Cabe√ßa', maxHealth: 35, currentHealth: 35, statuses: [] }, 'part-torso': { name: 'Tronco', maxHealth: 80, currentHealth: 80, statuses: [] }, 'part-l-arm': { name: 'Bra√ßo Esquerdo', maxHealth: 45, currentHealth: 45, statuses: [] }, 'part-r-arm': { name: 'Bra√ßo Direito', maxHealth: 45, currentHealth: 45, statuses: [] }, 'part-l-leg': { name: 'Perna Esquerda', maxHealth: 55, currentHealth: 55, statuses: [] }, 'part-r-leg': { name: 'Perna Direita', maxHealth: 55, currentHealth: 55, statuses: [] }
            };
            const defaultInventoryData = [ /* same as before */
                 { id: 'bandagem-default', name: 'Bandagem', quantity: 3, type: 'hp_local', effectValue: 15, statusTarget: null, icon: 'ü©π', description: 'Cura 15 HP local.' }, { id: 'antibiotico-default', name: 'Antibi√≥tico', quantity: 1, type: 'status_cure', effectValue: null, statusTarget: 'Infectado', icon: 'üíâ', description: 'Remove status Infectado.' }, { id: 'pomada-default', name: 'Pomada Queimadura', quantity: 1, type: 'status_cure', effectValue: null, statusTarget: 'Queimando', icon: 'üß¥', description: 'Remove status Queimando.' },
            ];

            // --- === DOM REFERENCES (Simplified) === ---
            const derivedCurrentHealthEl = document.getElementById('derived-current-health');
            const derivedHealthStatusEl = document.getElementById('derived-health-status');
            const generalDamageInputEl = document.getElementById('general-damage-input');
            const damageLogEl = document.getElementById('damage-log');
            const inventoryListEl = document.getElementById('inventory-list');
            const svgElement = document.getElementById('human-svg');
            const partElements = svgElement.querySelectorAll('.body-part-svg');
            const infoPanel = document.getElementById('info-panel');
            const infoPartName = document.getElementById('info-part-name');
            const infoPartHealth = document.getElementById('info-part-health');
            const infoPartMaxHealth = document.getElementById('info-part-max-health');
            const infoPartStatus = document.getElementById('info-part-status');
            const actionsDiv = document.getElementById('actions');
            const noSelectionMsg = document.getElementById('no-selection-msg');
            const resistanceInputs = document.querySelectorAll('.resistance-input');
            // const saveStatusEl = document.getElementById('save-status'); // Optional

            // --- === CORE LOGIC & HELPER FUNCTIONS === ---

            // --- Logging ---
            function addToLog(message, isInitial = false) {
                 if (!damageLogEl) return; const logEntry = document.createElement('p'); const now = new Date(); const timestamp = `[${now.toLocaleTimeString('pt-BR')}]`; logEntry.textContent = `${timestamp} ${message}`; logEntry.dataset.timestamp = now.getTime(); const firstEntry = damageLogEl.querySelector('p');
                 if (isInitial && firstEntry && firstEntry.dataset.timestamp === "0") { firstEntry.replaceWith(logEntry); }
                 else if (firstEntry && firstEntry.dataset.timestamp === "0") { firstEntry.remove(); damageLogEl.insertBefore(logEntry, damageLogEl.firstChild); }
                 else { damageLogEl.insertBefore(logEntry, damageLogEl.firstChild); }
                 while (damageLogEl.children.length > 50) { damageLogEl.removeChild(damageLogEl.lastChild); }
            }

            // --- Auto-Save Scheduling ---
            function scheduleAutoSave() {
                showSaveStatus("Salvando...");
                clearTimeout(autoSaveTimeoutId);
                autoSaveTimeoutId = setTimeout(saveStateToBrowser, AUTO_SAVE_DELAY);
            }

            function showSaveStatus(message, duration = 2000) {
                const saveStatusEl = document.getElementById('save-status');
                if (saveStatusEl) {
                    saveStatusEl.textContent = message;
                    saveStatusEl.classList.add('visible');

                    setTimeout(() => {
                        saveStatusEl.classList.remove('visible');
                    }, duration);
                }
            }

            // --- Reset Data to Default (Also Updates UI Inputs) ---
            function resetDataToDefault(logMessage = "Dados da ficha resetados para o padr√£o.") {
                 console.log("Resetting data to default.");
                 bodyPartsData = JSON.parse(JSON.stringify(defaultBodyPartsData));
                 inventoryData = JSON.parse(JSON.stringify(defaultInventoryData));
                 resistanceInputs.forEach(input => { input.value = 0; }); // Reset resistance inputs in UI
                 addToLog(logMessage);
                 updateAllVisuals(); // Ensure UI reflects the reset state
            }

            // --- Gather Current State ---
            function gatherCurrentState() {
                const currentState = {
                    version: DATA_VERSION,
                    bodyParts: bodyPartsData,
                    inventory: inventoryData,
                    resistances: {}
                };
                resistanceInputs.forEach(input => {
                    const type = input.id.replace('res-', '');
                    currentState.resistances[type] = parseInt(input.value, 10) || 0;
                });
                // console.log("Gathered state:", JSON.stringify(currentState).substring(0, 200)); // Debug
                return currentState;
            }

            // --- Save State (with Pako compression) ---
            function saveStateToBrowser() {
                try {
                    if (!window.pako) {
                        throw new Error("Pako library not loaded.");
                    }
                    const stateToSave = gatherCurrentState();
                    const jsonData = JSON.stringify(stateToSave);

                    // Compress the JSON string using pako
                    const compressedData = pako.deflate(jsonData);

                    // Convert Uint8Array to Base64 string for localStorage
                    // Using btoa after converting bytes to string - common method
                    let binaryString = '';
                    compressedData.forEach(byte => {
                       binaryString += String.fromCharCode(byte);
                    });
                    const base64String = btoa(binaryString);

                    localStorage.setItem(localStorageKey, base64String);
                    lastSaveTime = Date.now();
                    showSaveStatus("Salvo (comprimido)");
                    console.log(`Autosave successful. Original size: ${jsonData.length}, Compressed size: ${base64String.length}`);
                } catch (error) {
                    console.error("Erro no Auto-Save (com compress√£o):", error);
                    addToLog("ERRO: Falha ao salvar automaticamente (compress√£o)!");
                    showSaveStatus("Erro ao salvar!", 3000);

                    // Fallback: Try saving uncompressed if compression fails? (Optional)
                    // try {
                    //     const stateToSave = gatherCurrentState();
                    //     const jsonData = JSON.stringify(stateToSave);
                    //     localStorage.setItem(localStorageKey + "_uncompressed_fallback", jsonData);
                    //     addToLog("AVISO: Salvo sem compress√£o como fallback.");
                    // } catch (fallbackError) {
                    //     console.error("Erro no fallback de save:", fallbackError);
                    // }
                }
            }

            // --- Apply Loaded State (Updates JS Vars AND UI Inputs) ---
            function applyLoadedState(loadedData) {
                 if (!loadedData || typeof loadedData !== 'object') {
                    console.error("applyLoadedState: Invalid data received.");
                    return false;
                 }
                 console.log("Applying loaded state:", JSON.stringify(loadedData).substring(0, 200));

                 // Basic Version Check (Could add migration logic if needed)
                 if (!loadedData.version || !loadedData.version.startsWith(DATA_VERSION.split('-')[0])) {
                      addToLog(`AVISO: Carregando dados de vers√£o ${loadedData.version || 'desconhecida'} incompat√≠vel ou antiga. Pode haver problemas.`);
                 }

                 let loadedOk = true;

                  // Load Body Parts
                  if (loadedData.bodyParts && typeof loadedData.bodyParts === 'object' && Object.keys(loadedData.bodyParts).length === Object.keys(defaultBodyPartsData).length) {
                        bodyPartsData = JSON.parse(JSON.stringify(loadedData.bodyParts)); // Deep copy
                  } else { console.warn("Body parts data invalid/missing in loaded state."); loadedOk = false; }

                  // Load Inventory
                  if (loadedData.inventory && Array.isArray(loadedData.inventory)) {
                        inventoryData = JSON.parse(JSON.stringify(loadedData.inventory.filter(item => item && item.id && item.name && typeof item.quantity === 'number')));
                  } else { console.warn("Inventory data invalid/missing in loaded state."); loadedOk = false; } // Consider if this should fully invalidate the load

                  // Load Resistances AND Update UI Inputs
                  if (loadedData.resistances && typeof loadedData.resistances === 'object') {
                       resistanceInputs.forEach(input => {
                           const type = input.id.replace('res-', '');
                           const savedValue = loadedData.resistances[type];
                           if (typeof savedValue === 'number' && !isNaN(savedValue) && savedValue >= 0) {
                               input.value = savedValue; // Update the input field directly
                           } else {
                               input.value = 0; // Reset if invalid
                           }
                       });
                  } else {
                       console.warn("Resistance data invalid/missing in loaded state, resetting inputs.");
                       resistanceInputs.forEach(input => { input.value = 0; }); // Reset UI inputs
                       loadedOk = false; // Resistances are important, flag load as potentially incomplete
                  }

                   console.log("applyLoadedState finished. Success:", loadedOk);
                  return loadedOk; // Return true only if essential parts loaded okay
            }

            // --- Load State (with Pako decompression) ---
            function loadStateFromBrowser() {
                // if (saveStatusEl) saveStatusEl.textContent = "Carregando...";
                console.log("Attempting to load compressed state from browser...");
                try {
                    if (!window.pako) {
                        throw new Error("Pako library not loaded for decompression.");
                    }
                    const savedBase64 = localStorage.getItem(localStorageKey);
                    if (savedBase64) {
                        console.log("Found saved data (compressed).");

                        // Convert Base64 back to binary string
                        const binaryString = atob(savedBase64);

                        // Convert binary string to Uint8Array
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }

                        // Decompress using pako
                        const decompressedJsonString = pako.inflate(bytes, { to: 'string' });

                        const parsedData = JSON.parse(decompressedJsonString);

                        if (applyLoadedState(parsedData)) { // This updates JS vars and resistance inputs
                           addToLog("Progresso carregado e descomprimido do Navegador.");
                           console.log("Load and decompression successful.");
                           // No need to call resetDataToDefault here
                        } else {
                           addToLog("Falha ao aplicar dados carregados (ap√≥s descompress√£o). Resetando para padr√£o.");
                           resetDataToDefault("Falha ao carregar dados salvos, usando padr√£o."); // Reset vars and UI inputs
                        }
                    } else {
                         addToLog("Nenhum progresso salvo (comprimido) encontrado, usando padr√£o.");
                         console.log("No compressed save data found, using default.");
                         resetDataToDefault("Nenhum progresso salvo, usando padr√£o."); // Reset vars and UI inputs
                    }
               } catch (error) {
                    console.error("Erro CR√çTICO ao carregar/descomprimir progresso:", error);
                    addToLog("ERRO CR√çTICO ao carregar progresso! Resetando para padr√£o.");
                    resetDataToDefault("Erro cr√≠tico ao carregar, usando padr√£o."); // Reset vars and UI inputs

                    // Attempt to clear potentially corrupted data
                    try {
                        localStorage.removeItem(localStorageKey);
                        console.warn("Removed potentially corrupted save data for key:", localStorageKey);
                    } catch (removeError) {
                        console.error("Failed to remove corrupted data:", removeError);
                    }
                }
                // Update the rest of the UI (body map, health calc, inventory list) AFTER loading/resetting
                updateAllVisuals();
                // if (saveStatusEl) saveStatusEl.textContent = "Carregado.";
            }


            // --- UI Update Functions ---
            function updateInfoPanel() { /* same as before */
                if (selectedPartId && bodyPartsData[selectedPartId]) { const partData = bodyPartsData[selectedPartId]; infoPartName.textContent = partData.name; infoPartHealth.textContent = Math.max(0, partData.currentHealth); infoPartMaxHealth.textContent = partData.maxHealth; let statusText = partData.statuses.join(', ') || 'Nenhum'; if (partData.currentHealth <= 0) { statusText = 'Destru√≠do' + (partData.statuses.length > 0 ? `, ${partData.statuses.join(', ')}` : ''); } infoPartStatus.textContent = statusText; actionsDiv.classList.remove('hidden'); noSelectionMsg.classList.add('hidden'); } else { infoPartName.textContent = '-'; infoPartHealth.textContent = '--'; infoPartMaxHealth.textContent = '--'; infoPartStatus.textContent = '-'; actionsDiv.classList.add('hidden'); noSelectionMsg.classList.remove('hidden'); }
            }
            function updatePartVisuals(partId) { /* same as before */
                const partGroupElement = document.getElementById(partId); const pathElement = partGroupElement?.querySelector('path'); const partData = bodyPartsData[partId]; if (!partGroupElement || !pathElement || !partData) return; const currentHealth = Math.max(0, partData.currentHealth); const healthPercent = partData.maxHealth > 0 ? currentHealth / partData.maxHealth : 0; let healthColorVar; if (currentHealth <= 0) healthColorVar = 'var(--health-color-destroyed)'; else if (healthPercent < 0.3) healthColorVar = 'var(--health-color-critical)'; else if (healthPercent < 0.7) healthColorVar = 'var(--health-color-damaged)'; else healthColorVar = 'var(--health-color-healthy)'; pathElement.style.setProperty('--health-color', healthColorVar); partGroupElement.classList.toggle('bleeding', partData.statuses.includes('Sangrando')); partGroupElement.classList.toggle('infected', partData.statuses.includes('Infectado')); partGroupElement.classList.toggle('burning', partData.statuses.includes('Queimando')); partGroupElement.classList.toggle('selected', partId === selectedPartId);
            }
            function calculateGeneralHealth() { /* same as before */
                 let totalMaxHealth = 0; let totalCurrentHealth = 0; for (const partId in bodyPartsData) { if (bodyPartsData.hasOwnProperty(partId)) { totalMaxHealth += bodyPartsData[partId].maxHealth; totalCurrentHealth += Math.max(0, bodyPartsData[partId].currentHealth); } } const percentage = totalMaxHealth > 0 ? Math.round((totalCurrentHealth / totalMaxHealth) * 100) : 0; if (derivedCurrentHealthEl) derivedCurrentHealthEl.textContent = percentage; let status = "Desconhecido"; let statusColor = 'var(--text-color)'; if (percentage >= 95) { status = "Saud√°vel"; statusColor = 'var(--health-color-healthy)'; } else if (percentage >= 75) { status = "Levemente Ferido"; statusColor = 'var(--health-color-healthy)';} else if (percentage >= 50) { status = "Ferido"; statusColor = 'var(--health-color-damaged)'; } else if (percentage >= 25) { status = "Gravemente Ferido"; statusColor = 'var(--health-color-critical)'; } else if (percentage > 0) { status = "Criticamente Ferido"; statusColor = 'var(--health-color-critical)'; } else { status = "Inconsciente/Morto"; statusColor = 'var(--health-color-destroyed)';} let globalStatuses = new Set(); let destroyedParts = 0; let hasBleeding = false; let hasInfection = false; let hasBurning = false; for (const partId in bodyPartsData) { if (bodyPartsData.hasOwnProperty(partId)) { if (bodyPartsData[partId].currentHealth <= 0) destroyedParts++; if (bodyPartsData[partId].statuses.includes('Sangrando')) hasBleeding = true; if (bodyPartsData[partId].statuses.includes('Infectado')) hasInfection = true; if (bodyPartsData[partId].statuses.includes('Queimando')) hasBurning = true; } } if (destroyedParts > 0) globalStatuses.add(`${destroyedParts} Parte(s) Destru√≠da(s)`); if (hasBleeding) globalStatuses.add("Sangrando"); if (hasInfection) globalStatuses.add("Infectado"); if (hasBurning) globalStatuses.add("Queimando"); let combinedStatusText = status; if(globalStatuses.size > 0) combinedStatusText += ` (${Array.from(globalStatuses).join(', ')})`; if (derivedHealthStatusEl) { derivedHealthStatusEl.textContent = combinedStatusText; derivedHealthStatusEl.style.color = statusColor; }
            }
            function renderInventory() { /* same as before */
                 if (!inventoryListEl) return; inventoryListEl.innerHTML = ''; let hasItems = false; inventoryData.forEach(item => { if (item.quantity > 0) { hasItems = true; const li = document.createElement('li'); li.dataset.itemId = item.id; li.title = item.description || item.name; li.innerHTML = `<span class="item-icon">${item.icon || '?'}</span> <span class="item-name">${item.name}</span> <span class="item-qty">(x${item.quantity})</span>`; li.addEventListener('click', () => useItem(item.id)); inventoryListEl.appendChild(li); } }); if (!hasItems) inventoryListEl.innerHTML = '<li>Nenhum item dispon√≠vel.</li>';
            }
            function updateAllVisuals() { // Updates parts, health calc, inventory list
                 partElements.forEach(part => updatePartVisuals(part.id));
                 updateInfoPanel();
                 calculateGeneralHealth();
                 renderInventory();
                 console.log("UI visuals updated.");
            }

            // --- Damage/Healing/Status Functions (Now just call scheduleAutoSave) ---
            function getResistanceValue(type) { /* same */ const inputElement = document.getElementById(`res-${type.toLowerCase()}`); if (inputElement) { const value = parseInt(inputElement.value, 10); return !isNaN(value) && value >= 0 ? value : 0; } return 0; }
            function calculateReducedDamage(baseDamage, type) { /* same */ if (!validDamageTypes.includes(type.toLowerCase())) { type = 'fisico'; } const resistance = getResistanceValue(type); const reduction = Math.min(1, resistance / 100); return Math.max(0, Math.round(baseDamage * (1 - reduction))); }
            function applyDamageToPart(partId, baseDamage, type) { /* Added scheduleAutoSave */ if (!partId || !bodyPartsData[partId]) return; const partData = bodyPartsData[partId]; const reducedDamage = calculateReducedDamage(baseDamage, type); const oldHealth = partData.currentHealth; if (oldHealth <= 0) return; const damageTaken = Math.min(oldHealth, reducedDamage); if (damageTaken <= 0) return; partData.currentHealth -= damageTaken; addToLog(`${partData.name} sofreu ${damageTaken} de dano ${type}. Vida: ${partData.currentHealth}`); const partGroupElement = document.getElementById(partId); if (partGroupElement) { partGroupElement.classList.add('hit'); setTimeout(() => { partGroupElement.classList.remove('hit'); updatePartVisuals(partId); }, hitAnimationTimeout); } else { updatePartVisuals(partId); } updateInfoPanel(); calculateGeneralHealth(); scheduleAutoSave(); } // <-- Save triggered
            window.applyDamageGeneral = function() { /* Added scheduleAutoSave */ const baseDamage = parseInt(generalDamageInputEl.value, 10); if (isNaN(baseDamage) || baseDamage <= 0) return; let type = prompt(`Tipo de dano para ${baseDamage}? (${validDamageTypes.join(', ')})`, "Fisico"); if (!type) return; type = type.trim().toLowerCase(); if (!validDamageTypes.includes(type)) { addToLog(`Tipo inv√°lido: ${type}.`); return; } const reducedTotalDamage = calculateReducedDamage(baseDamage, type); if (reducedTotalDamage <= 0) { addToLog(`Dano ${type} (${baseDamage}) resistido.`); return; } const activeParts = Object.keys(bodyPartsData).filter(id => bodyPartsData[id].currentHealth > 0); if (activeParts.length === 0) { addToLog("Todas as partes destru√≠das."); return; } const damagePerPart = Math.max(1, Math.round(reducedTotalDamage / activeParts.length)); addToLog(`Distribuindo ${reducedTotalDamage} dano ${type} (~${damagePerPart} por parte)...`); activeParts.forEach(partId => { const partData = bodyPartsData[partId]; const damageTaken = Math.min(partData.currentHealth, damagePerPart); if (damageTaken > 0) { partData.currentHealth -= damageTaken; addToLog(` -> ${partData.name} sofre ${damageTaken} ${type}. Restante: ${partData.currentHealth}`); updatePartVisuals(partId); } }); updateInfoPanel(); calculateGeneralHealth(); scheduleAutoSave(); } // <-- Save triggered
            function healPart(partId, amount) { /* Added scheduleAutoSave */ if (!partId || !bodyPartsData[partId]) return false; const partData = bodyPartsData[partId]; if (partData.currentHealth <= 0) return false; const healedAmount = Math.min(amount, partData.maxHealth - partData.currentHealth); if (healedAmount <= 0) return false; partData.currentHealth += healedAmount; addToLog(`${partData.name} curado em ${healedAmount} HP.`); updatePartVisuals(partId); updateInfoPanel(); calculateGeneralHealth(); scheduleAutoSave(); return true; } // <-- Save triggered
            function addStatusToPart(partId, status) { /* Added scheduleAutoSave */ if (!partId || !bodyPartsData[partId]) return; const partData = bodyPartsData[partId]; if (partData.currentHealth <= 0) return; if (!partData.statuses.includes(status)) { partData.statuses.push(status); addToLog(`Status '${status}' aplicado a ${partData.name}.`); updatePartVisuals(partId); updateInfoPanel(); calculateGeneralHealth(); scheduleAutoSave(); } } // <-- Save triggered
            function removeStatusFromPart(partId, statusToRemove) { /* Added scheduleAutoSave */ if (!partId || !bodyPartsData[partId]) return false; const partData = bodyPartsData[partId]; const index = partData.statuses.indexOf(statusToRemove); if (index > -1) { partData.statuses.splice(index, 1); addToLog(`Status '${statusToRemove}' removido de ${partData.name}.`); updatePartVisuals(partId); updateInfoPanel(); calculateGeneralHealth(); scheduleAutoSave(); return true; } return false; } // <-- Save triggered

            // --- Inventory Functions (Now trigger save) ---
            function findItemById(itemId) { return inventoryData.find(item => item.id === itemId); }
            function useItem(itemId) { /* Added scheduleAutoSave */ const item = findItemById(itemId); if (!item || item.quantity <= 0) return; let requiresPartSelection = (item.type === 'hp_local' || item.type === 'status_cure'); if (requiresPartSelection && !selectedPartId) { alert(`Selecione uma parte do corpo para usar ${item.name}.`); return; } let success = false; let consumed = false; const targetName = selectedPartId ? bodyPartsData[selectedPartId]?.name : 'Geral'; const partData = selectedPartId ? bodyPartsData[selectedPartId] : null; if (item.type === 'hp_local') { if (partData && partData.currentHealth > 0 && partData.currentHealth < partData.maxHealth) consumed = true; success = healPart(selectedPartId, item.effectValue); } else if (item.type === 'status_cure') { if (!item.statusTarget) return; if (partData && partData.statuses.includes(item.statusTarget)) consumed = true; success = removeStatusFromPart(selectedPartId, item.statusTarget); } else { return; } if (success || consumed) { item.quantity--; if (success) addToLog(`Usou ${item.name} (Alvo: ${targetName}). Restante: ${item.quantity}`); else addToLog(`Usou ${item.name} (Alvo: ${targetName}), sem efeito vis√≠vel. Restante: ${item.quantity}`); renderInventory(); if (!success && consumed) scheduleAutoSave(); /* Save even if effect wasn't visible but item was consumed*/ else if(success) {/* Save is handled by healPart/removeStatusFromPart */} } } // <-- Save triggered (directly or via heal/cure)
            window.attemptGeneralHealingItem = function() { /* same */ if (!selectedPartId) { alert("Selecione uma parte do corpo!"); return; } const healingItem = inventoryData.find(item => item.type === 'hp_local' && item.quantity > 0); if (healingItem) { useItem(healingItem.id); } else { alert("Nenhum item de cura local!"); } }
            window.addInventoryItem = function() { /* Added scheduleAutoSave */ const name = prompt("Nome:", "Item"); if (!name) return; const quantity = parseInt(prompt("Qtd:", "1"), 10); if (isNaN(quantity) || quantity < 0) return; const type = prompt("Tipo? (hp_local / status_cure)", "hp_local"); if (type !== 'hp_local' && type !== 'status_cure') return; let effectValue = null, statusTarget = null; if (type === 'hp_local') { effectValue = parseInt(prompt("Cura HP:", "10"), 10); if (isNaN(effectValue)) return; } else { statusTarget = prompt("Status Cura:", "Infectado"); if (!statusTarget) return; } const icon = prompt("√çcone:", "‚ùì"); const description = prompt("Descri√ß√£o:", ""); const newItem = { id: name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now(), name, quantity, type, effectValue, statusTarget, icon: icon || '?', description: description || '' }; inventoryData.push(newItem); addToLog(`Adicionado ${quantity}x ${name}.`); renderInventory(); scheduleAutoSave(); } // <-- Save triggered

            // --- === EVENT LISTENERS === ---
            // Body Part Selection (No save needed)
            partElements.forEach(partGroupElement => { partGroupElement.addEventListener('click', () => { const newSelectedId = partGroupElement.id; if (selectedPartId !== newSelectedId) { if (selectedPartId) { document.getElementById(selectedPartId)?.classList.remove('selected'); } selectedPartId = newSelectedId; partGroupElement.classList.add('selected'); updateInfoPanel(); } }); });
            // Action Buttons (Call functions that now trigger save)
            document.getElementById('btn-damage-light')?.addEventListener('click', () => { const type = prompt(`Tipo dano (-10)? (${validDamageTypes.join(', ')})`, "Fisico"); if(type && validDamageTypes.includes(type.trim().toLowerCase())) applyDamageToPart(selectedPartId, 10, type.trim().toLowerCase()); });
            document.getElementById('btn-damage-heavy')?.addEventListener('click', () => { const type = prompt(`Tipo dano (-30)? (${validDamageTypes.join(', ')})`, "Fisico"); if(type && validDamageTypes.includes(type.trim().toLowerCase())) applyDamageToPart(selectedPartId, 30, type.trim().toLowerCase()); });
            document.getElementById('btn-bleed')?.addEventListener('click', () => addStatusToPart(selectedPartId, 'Sangrando'));
            document.getElementById('btn-infect')?.addEventListener('click', () => addStatusToPart(selectedPartId, 'Infectado'));
            document.getElementById('btn-burn')?.addEventListener('click', () => addStatusToPart(selectedPartId, 'Queimando'));
            document.getElementById('btn-cure-status')?.addEventListener('click', () => { const partData = selectedPartId ? bodyPartsData[selectedPartId] : null; if (!partData || partData.statuses.length === 0) return; const statusesToRemove = ['Queimando', 'Sangrando', 'Infectado']; for (const status of statusesToRemove) { if (removeStatusFromPart(selectedPartId, status)) break; /* Only remove one status per click */ } });
            // Resistance Input Listener (Triggers save)
            resistanceInputs.forEach(input => { input.addEventListener('input', scheduleAutoSave); });

            // Setup all auto-save triggering elements
            function setupAutoSaveListeners() {
                // All input elements should trigger save on change/blur
                document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                    // Use 'input' for immediate feedback, but 'change' or 'blur' might be less aggressive
                    // Using 'change' is a good balance - triggers after value changes and element loses focus or Enter is pressed.
                    // Using 'input' triggers on every keystroke, which might be too frequent.
                    input.addEventListener('change', scheduleAutoSave);
                    // Optionally add blur as well, though change often covers it
                    input.addEventListener('blur', scheduleAutoSave);
                });

                // Buttons handled by specific functions (applyDamageGeneral, addInventoryItem, attemptGeneralHealingItem, action buttons)
                // already call functions that schedule the save.

                // Setup periodic save as a backup
                periodicSaveIntervalId = setInterval(() => {
                    // Only save if there hasn't been a save in the last minute (or slightly less than interval)
                    if (Date.now() - lastSaveTime > PERIODIC_SAVE_INTERVAL - 500) {
                        console.log("Periodic auto-save triggered");
                        // Ensure any pending immediate save is cleared to avoid race condition
                        clearTimeout(autoSaveTimeoutId);
                        saveStateToBrowser();
                    }
                }, PERIODIC_SAVE_INTERVAL);

                // Save when user leaves the page or switches tabs
                window.addEventListener('beforeunload', () => {
                    // Ensure any pending scheduled save happens immediately before leaving
                    clearTimeout(autoSaveTimeoutId);
                    // Check if there were recent changes that might not have triggered save yet
                    // (This is hard to track perfectly without more state, so just save unconditionally)
                    console.log("beforeunload: Saving state...");
                    saveStateToBrowser(); // Use synchronous save if possible, but localStorage is sync anyway
                });
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        // Tab switched away or window minimized
                        clearTimeout(autoSaveTimeoutId);
                        console.log("visibilitychange (hidden): Saving state...");
                        saveStateToBrowser();
                    }
                });
            }


            // --- === INITIALIZATION === ---
            console.log("Initializing Character Sheet (with Pako compression)...");
            // Check if Pako is loaded
            if (!window.pako) {
                const errorMsg = "ERRO CR√çTICO: Biblioteca de compress√£o (Pako) n√£o carregada! Auto-save n√£o funcionar√° corretamente.";
                console.error(errorMsg);
                addToLog(errorMsg, true);
                alert(errorMsg); // Alert user immediately
                // Optionally disable saving features or just proceed knowing it will fail
                // For now, let loadStateFromBrowser handle the error
            }

            loadStateFromBrowser(); // Load state (or reset) AND update UI
            setupAutoSaveListeners(); // Setup all auto-save triggering elements
            addToLog("Sistema de Ficha com Auto-Save (comprimido) iniciado.", true);
            console.log("Initialization complete.");

        }); // End DOMContentLoaded
    </script>
</body>
</html>